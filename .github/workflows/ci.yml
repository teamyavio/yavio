name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # ── Change Detection ───────────────────────────────────────────────
  detect:
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      db: ${{ steps.filter.outputs.db }}
      sdk: ${{ steps.filter.outputs.sdk }}
      ingest: ${{ steps.filter.outputs.ingest }}
      dashboard: ${{ steps.filter.outputs.dashboard }}
      cli: ${{ steps.filter.outputs.cli }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            shared:
              - 'packages/shared/**'
              - '.github/**'
            db:
              - 'packages/db/**'
              - 'packages/shared/**'
              - '.github/**'
            sdk:
              - 'packages/sdk/**'
              - 'packages/shared/**'
              - '.github/**'
            ingest:
              - 'packages/ingest/**'
              - 'packages/shared/**'
              - 'packages/db/**'
              - '.github/**'
            dashboard:
              - 'packages/dashboard/**'
              - 'packages/shared/**'
              - 'packages/db/**'
              - '.github/**'
            cli:
              - 'packages/cli/**'
              - 'packages/shared/**'
              - '.github/**'
            docs:
              - 'packages/docs/**'
              - '.github/**'

  # ── Lint & Format ──────────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm exec biome check .

  # ── Type Check ─────────────────────────────────────────────────────
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm turbo typecheck

  # ── Unit Tests: shared ─────────────────────────────────────────────
  test-shared:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.shared == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm --filter @yavio/shared exec vitest run --coverage
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: coverage-shared
          path: packages/shared/coverage/

  # ── Tests: db (requires PostgreSQL + ClickHouse) ───────────────────
  test-db:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.db == 'true'
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: yavio_test
          POSTGRES_USER: yavio_service
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U yavio_service"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
      clickhouse:
        image: clickhouse/clickhouse-server:24.3
        env:
          CLICKHOUSE_PASSWORD: test
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
        ports:
          - 8123:8123
        options: >-
          --health-cmd "clickhouse-client --password test --query 'SELECT 1'"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm --filter @yavio/shared build
      - run: pnpm --filter @yavio/db exec vitest run --coverage
        env:
          DATABASE_URL: postgres://yavio_service:test@localhost:5432/yavio_test
          CLICKHOUSE_URL: http://localhost:8123
          CLICKHOUSE_PASSWORD: test
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: coverage-db
          path: packages/db/coverage/

  # ── Tests: ingest (requires ClickHouse for e2e) ────────────────────
  test-ingest:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.ingest == 'true'
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:24.3
        env:
          CLICKHOUSE_PASSWORD: test
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
        ports:
          - 8123:8123
        options: >-
          --health-cmd "clickhouse-client --password test --query 'SELECT 1'"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm turbo build --filter=@yavio/ingest...
      - run: pnpm --filter @yavio/ingest exec vitest run --coverage
        env:
          CLICKHOUSE_URL: http://localhost:8123
          CLICKHOUSE_PASSWORD: test
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: coverage-ingest
          path: packages/ingest/coverage/

  # ── Tests: dashboard (requires PostgreSQL + ClickHouse) ────────────
  test-dashboard:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.dashboard == 'true'
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: yavio_test
          POSTGRES_USER: yavio_service
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U yavio_service"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
      clickhouse:
        image: clickhouse/clickhouse-server:24.3
        env:
          CLICKHOUSE_PASSWORD: test
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
        ports:
          - 8123:8123
        options: >-
          --health-cmd "clickhouse-client --password test --query 'SELECT 1'"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm turbo build --filter=@yavio/dashboard...
      - run: pnpm --filter @yavio/dashboard exec vitest run --coverage
        env:
          DATABASE_URL: postgres://yavio_service:test@localhost:5432/yavio_test
          CLICKHOUSE_URL: http://localhost:8123
          CLICKHOUSE_PASSWORD: test
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: coverage-dashboard
          path: packages/dashboard/coverage/

  # ── Tests: cli ─────────────────────────────────────────────────────
  test-cli:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.cli == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm turbo build --filter=@yavio/cli...
      - run: pnpm --filter @yavio/cli exec vitest run --coverage
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: coverage-cli
          path: packages/cli/coverage/

  # ── Tests: sdk ─────────────────────────────────────────────────────
  test-sdk:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.sdk == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm turbo build --filter=@yavio/sdk...
      - run: pnpm --filter @yavio/sdk exec vitest run --coverage
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: coverage-sdk
          path: packages/sdk/coverage/

  # ── Coverage Report (PR comment) ──────────────────────────────────
  coverage-report:
    if: github.event_name == 'pull_request' && always()
    needs: [test-shared, test-db, test-ingest, test-dashboard, test-cli, test-sdk]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          pattern: coverage-*
          merge-multiple: false

      - name: Coverage report — shared
        if: needs.test-shared.result == 'success'
        uses: davelosert/vitest-coverage-report-action@2500dafcee7dd64f85ab689c0b83798a8359770e # v2.9.3
        with:
          name: shared
          json-summary-path: coverage-shared/coverage-summary.json
          json-final-path: coverage-shared/coverage-final.json

      - name: Coverage report — db
        if: needs.test-db.result == 'success'
        uses: davelosert/vitest-coverage-report-action@2500dafcee7dd64f85ab689c0b83798a8359770e # v2.9.3
        with:
          name: db
          json-summary-path: coverage-db/coverage-summary.json
          json-final-path: coverage-db/coverage-final.json

      - name: Coverage report — ingest
        if: needs.test-ingest.result == 'success'
        uses: davelosert/vitest-coverage-report-action@2500dafcee7dd64f85ab689c0b83798a8359770e # v2.9.3
        with:
          name: ingest
          json-summary-path: coverage-ingest/coverage-summary.json
          json-final-path: coverage-ingest/coverage-final.json

      - name: Coverage report — dashboard
        if: needs.test-dashboard.result == 'success'
        uses: davelosert/vitest-coverage-report-action@2500dafcee7dd64f85ab689c0b83798a8359770e # v2.9.3
        with:
          name: dashboard
          json-summary-path: coverage-dashboard/coverage-summary.json
          json-final-path: coverage-dashboard/coverage-final.json

      - name: Coverage report — cli
        if: needs.test-cli.result == 'success'
        uses: davelosert/vitest-coverage-report-action@2500dafcee7dd64f85ab689c0b83798a8359770e # v2.9.3
        with:
          name: cli
          json-summary-path: coverage-cli/coverage-summary.json
          json-final-path: coverage-cli/coverage-final.json

      - name: Coverage report — sdk
        if: needs.test-sdk.result == 'success'
        uses: davelosert/vitest-coverage-report-action@2500dafcee7dd64f85ab689c0b83798a8359770e # v2.9.3
        with:
          name: sdk
          json-summary-path: coverage-sdk/coverage-summary.json
          json-final-path: coverage-sdk/coverage-final.json

  # ── Build ──────────────────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - run: pnpm turbo build

  # ── Security ───────────────────────────────────────────────────────
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: ./.github/actions/setup
      - name: Audit dependencies
        run: |
          OUTPUT=$(pnpm audit --audit-level=high 2>&1) && { echo "$OUTPUT"; exit 0; }
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "ERR_PNPM_AUDIT_BAD_RESPONSE"; then
            echo "::warning::pnpm audit skipped — npm registry returned a server error"
            exit 0
          fi
          exit 1
